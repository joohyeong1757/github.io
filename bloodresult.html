<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>혈액검사 결과</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet"
    crossorigin="anonymous">
  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
      max-width: 1000px;
      margin: auto;
    }

    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }


    .table-container {
      position: relative;
      overflow-x: auto;
      margin-bottom: 1rem;
    }

    .table-container::after {
      display: none;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      text-align: center;
      white-space: nowrap;
      border: 1px solid #dee2e6;
    }

    /* 첫 번째 열 고정 */
    table th:first-child,
    table td:first-child {
      position: sticky;
      left: 0;
      background: #fff;
      z-index: 1;
    }

    /* 헤더 고정
    table thead th {
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 2;
    }
       */

    table thead th:first-child {
      z-index: 3;
    }

    /* 커스텀 툴팁 */
    th[data-tooltip] {
      color: #007bff;
      position: relative;
      cursor: pointer;
    }

    /* 호버 시 셀 배경을 연한 회색으로 */
    th[data-tooltip]:hover {
      background-color: #f0f0f0;
      /* 연한 그레이 */
    }

    th[data-tooltip]::after {
      font-size: 12px;
      /* ← 툴팁 텍스트 크기 */
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-4px);
      background: rgba(0, 0, 0, 0.75);
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      white-space: nowrap;
      opacity: 0;
      transform: translate(2px, 50%);
      transition: opacity 0.1s ease-in;
      z-index: 10;
    }


    th[data-tooltip]:hover::after {
      opacity: 1;
    }

    .chart-container {
      position: relative;
      width: 1000px;
      height: 500px;
      overflow-x: auto;
      margin: 1rem auto 0;
      text-align: center;
    }

    .chart-container canvas {
      display: inline-block;
      height: 100% !important;
    }

    :root {
      --btn-h: 48px;
      --gap: .5rem;
    }

    /* 전체 레이아웃: 왼쪽 고정, 오른쪽 가변 */
    #filter-buttons.filters-row {
      display: flex;
      gap: var(--gap);
      padding: 0 .5rem;
      align-items: stretch;
      /* 왼쪽 버튼 세로로 꽉 차도록 */
      margin-bottom: 24px;
      /* 버튼과 표 사이 여백 */
    }

    /* 전체보기 버튼 */
    #filter-buttons .btn-all {
      flex: 0 0 140px;
      /* 너비 고정 */
      border-radius: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      /* 높이는 부모 높이에 맞춰 자동 늘어남 (align-items:stretch 영향) */
    }

    /* 오른쪽 영역 */
    #filter-buttons .other-btns {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      gap: var(--gap);
      align-content: flex-start;
      position: relative;
    }

    /* 개별 버튼: 기본은 내용만큼만, 줄바꿈 금지 */
    #filter-buttons .other-btns .btn {
      white-space: nowrap;
      height: var(--btn-h);
      line-height: var(--btn-h);
      flex: 0 0 auto;
      /* 기본은 내용폭 */
      padding: 0 18px;
    }

    /* active 색상 */
    #filter-buttons .btn.active {
      background: #0d6efd;
      color: #fff;
    }

    /* 데스크톱 */
    @media (max-width:600px) {}

    @media (min-width: 601px) and (max-width: 1024px) {
      .chart-container {
        width: 95%;
        height: 500px;
      }
    }

    @media (max-width: 600px) {
      body {
        padding: 0.5rem;
      }

      .chart-container {
        width: 100%;
        height: 500px;
      }

      #filter-buttons {
        margin-bottom: 16px;
      }

      /* 모바일 */
    }
  </style>
</head>

<body>
  <h1>혈액검사 결과</h1>
  <!-- 필터 버튼 -->
  <div id="filter-buttons" class="filters-row" role="group">
    <button class="btn btn-outline-secondary active btn-all" data-cat="all">전체보기</button>

    <div class="other-btns">
      <button class="btn btn-outline-secondary" data-cat="tumor">종양수치</button>
      <button class="btn btn-outline-secondary" data-cat="infection">면역기능</button>
      <button class="btn btn-outline-secondary" data-cat="anemia">빈혈 여부 등</button>
      <button class="btn btn-outline-secondary" data-cat="bleeding">혈소판</button>
      <button class="btn btn-outline-secondary" data-cat="kidney">신장 기능</button>
      <button class="btn btn-outline-secondary" data-cat="liver">간 기능 및 간세포 손상</button>
      <button class="btn btn-outline-secondary" data-cat="cholestasis">담즙 정체 여부</button>
      <button class="btn btn-outline-secondary" data-cat="electrolyte">체액/전해질 균형</button>
      <button class="btn btn-outline-secondary" data-cat="nutrition">영양 상태/간단백 생성능</button>
      <button class="btn btn-outline-secondary" data-cat="bone">뼈 및 무기질 대사 상태</button>
    </div>
  </div>
  <div class="table-container">
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>항목</th>
        </tr>
      </thead>
      <tbody id="data-table"></tbody>
    </table>
  </div>
  <div class="chart-container" id="chart-container">
    <canvas id="chart"></canvas>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script>
    // 데이터 및 필드 정의
    const results = [
      { date: '2025-07-15', ca19_9: 1900, wbc: 5.48, rbc: 2.62, hb: 8.1, hct: 26.4, platelet: 91, anc: 3935, lymph: 970, mono: 362, na: 141, k: 3.9, cl: 108, bun: 22, cr: 0.85, egfr_mdrd: 89.9, egfr_ckd_epi: 90.2, egfr_schwartz: 82.8, egfr_cg: 66.8, tb: 0.66, ast: 42, alt: 35, ca_total: 9.0, p: 3.6, t_protein: 6.7, albumin: 3.8, alk_phos: 104, ggt: 95 },
      { date: '06-25', ca19_9: 1740, wbc: 5.49, rbc: 2.75, hb: 8.3, hct: 27.6, platelet: 99, anc: 3827, lymph: 889, mono: 533, na: 140, k: 4.0, cl: 105, bun: 25, cr: 0.86, egfr_mdrd: 88.7, egfr_ckd_epi: 89.7, egfr_schwartz: 82.6, egfr_cg: 68.1, tb: 0.70, ast: 53, alt: 42, ca_total: 8.7, p: 3.6, t_protein: 6.9, albumin: 4.1, alk_phos: 111, ggt: 95 },
      { date: '06-05', ca19_9: 980, wbc: 4.12, rbc: 2.70, hb: 8.1, hct: 27.4, platelet: 101, anc: 2587, lymph: 911, mono: 420, na: 140, k: 4.0, cl: 105, bun: 20, cr: 0.93, egfr_mdrd: 81.0, egfr_ckd_epi: 84.6, egfr_schwartz: 76.1, egfr_cg: 62.9, tb: 0.62, ast: 44, alt: 35, ca_total: 9.1, p: 3.9, t_protein: 6.9, albumin: 4.1, alk_phos: 117, ggt: 66 },
      { date: '05-16', ca19_9: 850, wbc: 3.25, rbc: 2.58, hb: 7.9, hct: 26.0, platelet: 88, anc: 1680, lymph: 809, mono: 510, na: 141, k: 4.0, cl: 104, bun: 21, cr: 0.95, egfr_mdrd: 79.1, egfr_ckd_epi: 82.5, egfr_schwartz: 74.5, egfr_cg: 58.6, tb: 0.49, ast: 44, alt: 34, ca_total: 9.2, p: 3.0, t_protein: 6.8, albumin: 3.7, alk_phos: 110, ggt: 61 },
      { date: '04-22', ca19_9: 760, wbc: 4.03, rbc: 2.76, hb: 8.7, hct: 28.2, platelet: 102, anc: 1826, lymph: 1249, mono: 609, na: 141, k: 4.1, cl: 105, bun: 25, cr: 0.93, egfr_mdrd: 81.0, egfr_ckd_epi: 84.6, egfr_schwartz: 76.1, egfr_cg: 61.5, tb: 0.51, ast: 32, alt: 26, ca_total: 9.2, p: 3.8, t_protein: 7.3, albumin: 4.1, alk_phos: 109, ggt: 53 },
      { date: '04-02', ca19_9: 740, wbc: 3.34, rbc: 2.76, hb: 8.7, hct: 28.1, platelet: 108, anc: 1690, lymph: 848, mono: 571, na: 144, k: 4.2, cl: 107, bun: 26, cr: 1.01, egfr_mdrd: 73.7, egfr_ckd_epi: 76.6, egfr_schwartz: 69.9, egfr_cg: 56.2, tb: 0.44, ast: 38, alt: 24, ca_total: 9.0, p: 3.9, t_protein: 7.0, albumin: 4.0, alk_phos: 109, ggt: 51 },
      { date: '03-12', ca19_9: 870, wbc: 3.93, rbc: 2.84, hb: 9.0, hct: 29.5, platelet: 138, anc: 2319, lymph: 920, mono: 538, na: 141, k: 4.3, cl: 106, bun: 27, cr: 0.94, egfr_mdrd: 80.0, egfr_ckd_epi: 83.6, egfr_schwartz: 75.3, egfr_cg: 61.4, tb: 0.45, ast: 29, alt: 20, ca_total: 9.0, p: 3.5, t_protein: 6.7, albumin: 3.7, alk_phos: 116, ggt: 50 },
      { date: '02-19', ca19_9: 1280, wbc: 4.18, rbc: 2.81, hb: 8.9, hct: 28.5, platelet: 109, anc: 2684, lymph: 798, mono: 531, na: 142, k: 4.6, cl: 108, bun: 17, cr: 0.90, egfr_mdrd: 84.2, egfr_ckd_epi: 88.1, egfr_schwartz: 78.7, egfr_cg: 63.0, tb: 0.59, ast: 37, alt: 26, ca_total: 9.2, p: 3.5, t_protein: 6.5, albumin: 3.8, alk_phos: 116, ggt: 51 },
      { date: '01-31', ca19_9: 1720, wbc: 4.13, rbc: 2.84, hb: 9.0, hct: 28.3, platelet: 140, anc: 2243, lymph: 1028, mono: 611, na: 143, k: 4.7, cl: 106, bun: 17, cr: 0.89, egfr_mdrd: 85.3, egfr_ckd_epi: 88.5, egfr_schwartz: 79.3, egfr_cg: 63.7, tb: 0.63, ast: 39, alt: 27, ca_total: 8.8, p: 3.9, t_protein: 6.8, albumin: 4.0, alk_phos: 103, ggt: 58 },
      { date: '01-08', ca19_9: 3700, wbc: 3.99, rbc: 3.01, hb: 9.1, hct: 29.9, platelet: 152, anc: 2366, lymph: 930, mono: 571, na: 140, k: 4.9, cl: 101, bun: 22, cr: 0.89, egfr_mdrd: 85.3, egfr_ckd_epi: 88.5, egfr_schwartz: 79.3, egfr_cg: 64.1, tb: 0.39, ast: 39, alt: 24, ca_total: 9.0, p: 4.1, t_protein: 7.0, albumin: 3.7, alk_phos: 103, ggt: 54 },
      { date: '2024-12-18', ca19_9: 7900, wbc: 1.80, rbc: 3.02, hb: 9.5, hct: 30.0, platelet: 105, anc: 558, lymph: 612, mono: 468, na: 139, k: 4.4, cl: 104, bun: 17, cr: 0.95, egfr_mdrd: 79.1, egfr_ckd_epi: 82.5, egfr_schwartz: 74.5, egfr_cg: 59.1, tb: 0.48, ast: 33, alt: 23, ca_total: 8.9, p: 3.2, t_protein: 6.7, albumin: 3.8, alk_phos: 101, ggt: 52 },
      { date: '11-01', ca19_9: 10000, wbc: 3.61, rbc: 3.25, hb: 10.0, hct: 32.0, platelet: 131, anc: 1841, lymph: 1069, mono: 440, na: null, k: null, cl: null, bun: 22, cr: 0.94, egfr_mdrd: 80.0, egfr_ckd_epi: 83.6, egfr_schwartz: 75.4, egfr_cg: 61.9, tb: 0.63, ast: 38, alt: 31, ca_total: 9.1, p: 4.1, t_protein: 7.1, albumin: 4.1, alk_phos: 114, ggt: 52 },
      { date: '09-30', ca19_9: 2200, wbc: 4.93, rbc: 3.28, hb: 10.3, hct: 33.4, platelet: 147, anc: 2766, lymph: 1331, mono: 592, na: null, k: null, cl: null, bun: 16, cr: 0.93, egfr_mdrd: 81.0, egfr_ckd_epi: 84.6, egfr_schwartz: 76.1, egfr_cg: 59.5, tb: 0.54, ast: 36, alt: 31, ca_total: 9.5, p: 4.0, t_protein: 7.5, albumin: 4.4, alk_phos: 105, ggt: 62 },
    ];

    // 2) 표시할 필드와 레이블 정의
    const fields = [
      { key: 'ca19_9', label: 'CA19‑9 (U/mL)' },
      { key: 'wbc', label: '백혈구수 (10³/µL)' },
      { key: 'rbc', label: '적혈구수 (10¹²/µL)' },
      { key: 'hb', label: '헤모글로빈 (g/dL)' },
      { key: 'hct', label: '헤마토크릿 (%)' },
      { key: 'platelet', label: '혈소판 (10³/µL)' },
      { key: 'anc', label: 'ANC (절대 호중구 수)' },
      { key: 'lymph', label: '림프구 (cells/µL)' },
      { key: 'mono', label: '단핵구 (cells/µL)' },
      { key: 'na', label: 'Na (mmol/L)' },
      { key: 'k', label: 'K (mmol/L)' },
      { key: 'cl', label: 'Cl (mmol/L)' },
      { key: 'bun', label: 'BUN (mg/dL)' },
      { key: 'cr', label: 'Cr (mg/dL)' },
      { key: 'egfr_mdrd', label: 'eGFR‑MDRD' },
      { key: 'egfr_ckd_epi', label: 'eGFR‑CKD‑EPI' },
      { key: 'egfr_schwartz', label: 'eGFR‑Schwartz' },
      { key: 'egfr_cg', label: 'eGFR‑Cockcroft‑Gault' },
      { key: 'tb', label: '총빌리루빈 (mg/dL)' },
      { key: 'ast', label: 'AST (U/L)' },
      { key: 'alt', label: 'ALT (U/L)' },
      { key: 'ca_total', label: '총칼슘 (mg/dL)' },
      { key: 'p', label: '인 (mg/dL)' },
      { key: 't_protein', label: '총단백 (g/dL)' },
      { key: 'albumin', label: '알부민 (g/dL)' },
      { key: 'alk_phos', label: 'ALP (U/L)' },
      { key: 'ggt', label: 'GGT (U/L)' }
    ];

    // 카테고리
    const categories = {
      tumor: ['ca19_9'],
      infection: ['wbc', 'anc', 'lymph', 'mono'],
      anemia: ['rbc', 'hb', 'hct'],
      bleeding: ['platelet'],
      kidney: ['cr', 'bun', 'egfr_mdrd', 'egfr_ckd_epi', 'egfr_schwartz', 'egfr_cg'],
      liver: ['ast', 'alt', 'tb'],
      cholestasis: ['alk_phos', 'ggt'],
      electrolyte: ['na', 'k', 'cl'],
      nutrition: ['t_protein', 'albumin'],
      bone: ['ca_total', 'p']
    };

    // 역매핑(키→카테고리) 만들어두면 편합니다
    const catIndex = Object.fromEntries(
      Object.entries(categories).flatMap(([cat, keys]) => keys.map(k => [k, cat]))
    );

    // 기준값(threshold) 맵
    const thresholds = {
      ca19_9: 37,
      tb: 1.2,
      ast: 40,
      alt: 40,
      alk_phos: 115,
      ggt: 63
    };
    const theadRow = document.querySelector('thead tr');
    results.forEach(r => {
      const th = document.createElement('th');
      th.textContent = r.date;
      theadRow.appendChild(th);
    });

    // 테이블 바디 생성
    const tbody = document.getElementById('data-table');
    fields.forEach(f => {
      const tr = document.createElement('tr');
      const th = document.createElement('th');
      th.setAttribute('scope', 'row');
      th.dataset.key = f.key;

      // 기본 레이블/툴팁 처리 (괄호)
      let mainLabel = f.label;
      let tooltip = '';
      const paren = f.label.match(/^(.*?)\s*\((.*?)\)$/);
      if (paren) {
        mainLabel = paren[1].trim();
        tooltip = paren[2].trim();
      }

      // ▼ 여기서 카테고리 지정
      tr.dataset.cat = catIndex[f.key] || 'all';
      const cat = Object.keys(categories).find(c => categories[c].includes(f.key)) || 'all';
      tr.dataset.cat = cat;
      tr.appendChild(th);

      // eGFR별 특별 처리
      switch (f.key) {
        case 'egfr_mdrd':
          mainLabel = 'eGFR'; tooltip = 'MDRD'; break;
        case 'egfr_ckd_epi':
          mainLabel = 'eGFR'; tooltip = 'CKD‑EPI'; break;
        case 'egfr_schwartz':
          mainLabel = 'eGFR'; tooltip = 'Schwartz'; break;
        case 'egfr_cg':
          mainLabel = 'eGFR'; tooltip = 'Cock‑Gault'; break;
      }

      th.textContent = mainLabel;
      if (tooltip) th.setAttribute('data-tooltip', tooltip);
      tr.appendChild(th);

      // 데이터 셀 추가
      results.forEach(r => {
        const td = document.createElement('td');
        td.textContent = r[f.key] != null ? r[f.key] : '';
        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });
    // 단위 매핑 생성
    const unitMap = fields.reduce((map, f) => {
      const m = f.label.match(/\((.*?)\)/);
      map[f.key] = m ? m[1] : '';
      return map;
    }, {});

    // ★ 여기부터 (테이블 생성이 끝난 바로 다음)
    function filterTable(cat) {
      document.querySelectorAll('#data-table tr').forEach(row => {
        row.style.display = (cat === 'all' || row.dataset.cat === cat) ? '' : 'none';
      });
    }

    // 버튼 이벤트
    document.querySelectorAll('#filter-buttons button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#filter-buttons button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        filterTable(btn.dataset.cat);
      });
    });

    // 초기 상태: 전체보기
    filterTable('all');

    function spreadRowWidths() {
      const area = document.querySelector('#filter-buttons .other-btns');
      const btns = [...area.querySelectorAll('.btn')];

      // 초기화 (리사이즈 때 재계산 위해)
      btns.forEach(b => b.style.flexBasis = '');

      const rows = [];
      let currentTop = null;
      let row = [];

      btns.forEach(b => {
        const top = b.offsetTop;
        if (currentTop === null || Math.abs(top - currentTop) < 2) {
          row.push(b);
          currentTop = top;
        } else {
          rows.push(row);
          row = [b];
          currentTop = top;
        }
      });
      if (row.length) rows.push(row);

      // 각 줄별로 남은 공간 나눠주기
      const gapPx = parseFloat(getComputedStyle(area).gap) || 0;
      rows.forEach(r => {
        const parentWidth = area.clientWidth;
        const totalBtnsW = r.reduce((sum, b) => sum + b.offsetWidth, 0);
        const totalGapW = gapPx * (r.length - 1);
        const extra = parentWidth - totalBtnsW - totalGapW;
        if (extra > 0) {
          const add = extra / r.length;   // 한 버튼씩 늘릴 폭
          r.forEach(b => {
            const w = b.offsetWidth;
            b.style.flexBasis = `calc(${w}px + ${add}px)`;
          });
        }
      });
    }

    // 최초 / 리사이즈 시 실행
    window.addEventListener('load', spreadRowWidths);
    window.addEventListener('resize', spreadRowWidths);



    // 차트 생성 & 갱신
    let chart;
    const ctx = document.getElementById('chart').getContext('2d');
    function showChart(key, label) {
      const container = document.getElementById('chart-container');
      container.style.display = 'block'; container.scrollIntoView({ behavior: 'smooth' });
      if (chart) chart.destroy();
      const threshold = thresholds[key];
      // 포인트 색상 배열
      const pointColors = results.map(r => threshold != null && r[key] > threshold ? 'red' : 'blue');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: results.map(r => r.date),
          datasets: [{
            label,
            data: results.map(r => r[key]),
            fill: false,
            tension: 0.2,
            pointBackgroundColor: pointColors,
            pointRadius: 5
          }]
        },
        options: {
          maintainAspectRatio: false,
          plugins: {
            tooltip: {
              enabled: true,
              mode: 'nearest', intersect: false,
              borderRadius: 4,
              callbacks: {
                title: () => '',
                label: context => {
                  const value = context.parsed.y;
                  const unit = unitMap[key];
                  return unit ? `${value} ${unit}` : `${value}`;
                }
              }
            }
          },
          scales: {
            x: { title: { display: true, text: '날짜' } },
            y: { beginAtZero: false }
          }
        },
        plugins: [{
          id: 'thresholdLine',
          beforeDraw: chartInstance => {
            const thresholdValue = thresholds[key];
            if (thresholdValue == null) return;
            const yScale = chartInstance.scales.y;
            const yPixel = yScale.getPixelForValue(thresholdValue);
            const { left, right } = chartInstance.chartArea;
            const ctx2 = chartInstance.ctx;
            ctx2.save();
            ctx2.setLineDash([5, 5]);
            ctx2.strokeStyle = '#888';
            ctx2.beginPath(); ctx2.moveTo(left, yPixel); ctx2.lineTo(right, yPixel); ctx2.stroke();
            ctx2.restore();
          }
        }]
      });
    }
    document.querySelectorAll('#data-table th[data-key]').forEach(th => th.addEventListener('click', () => showChart(th.dataset.key, th.textContent)));
  </script>
</body>

</html>